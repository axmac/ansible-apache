---
# tasks file for axmac.apache
- name: Install apache
  yum:
    name: httpd
    state: latest

- name: Install mod_ssl
  yum:
    name: mod_ssl
    state: latest

- name: Enable service
  service:
    name: httpd
    enabled: yes

- name: Create directory to store certificates
  tags: certificates
  file:
    path: "{{ ssl_cert_directory }}"
    state: directory

- name: Copy CA certificate public key
  tags: certificates
  copy:
    src: "{{ apache_certificates.ca_cert_src }}"
    dest: "{{ apache_certificates_dir.ca_cert }}"
  notify: restart apache

- name: Copy server certificate public key
  tags: certificates
  copy:
    src: "{{ apache_certificates.server_cert_src }}"
    dest: "{{ apache_certificates_dir.server_cert }}"
  notify: restart apache

- name: Copy server certificate private key
  tags: certificates
  copy:
    src: "{{ apache_certificates.server_key_src }}"
    dest: "{{ apache_certificates_dir.server_key }}"
  notify: restart apache

- name: Create apache log directory
  file:
    path: "{{ apache_log_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  notify: restart apache

- name: Apply httpd.conf
  template:
    src: httpd.conf.j2
    dest: "{{ apache_path }}/conf/httpd.conf"
    owner: root
    group: root
    mode: 0644
  notify: restart apache

- name: Apply ssl.conf
  template:
    src: ssl.conf.j2
    dest: "{{ apache_path }}/conf.d/ssl.conf"
    owner: root
    group: root
    mode: 0644
  notify: restart apache

- name: Apply vhosts
  template:
    src: vhost.conf.j2
    dest: "{{ apache_path }}/conf.d/{{ apache_vhosts_file }}"
    owner: root
    group: root
    mode: 0644
  notify: restart apache
